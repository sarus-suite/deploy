#!/bin/bash

function get_sarus_env_status() {
  if [ -n "$CONTAINERS_CONF" ]
  then
    if [ "$CONTAINERS_CONF" == "${SARUS_PATH}/etc/containers.conf" ]
    then
      echo "active"
      return 0
    fi
  fi
  echo "inactive"
  return 0
}

function sarus_env_activate() {
  SARUS_PATH=$(dirname $(dirname $(readlink -f "${BASH_SOURCE[0]}")))
  TMP_PARALLAX_IMAGESTORE="/tmp/${USER}/parallax_imagestore"
  
  if [ -n "$CONTAINERS_CONF" ]
  then
    if [ "$CONTAINERS_CONF" == "${SARUS_PATH}/etc/containers.conf" ]
    then
      echo "Sarus environment is already active."
      return 0
    fi
    export CONTAINERS_CONF_ORIG=$CONTAINERS_CONF
  fi

  if [ -n "$PATH" ]
  then
    export PATH_ORIG=$PATH
  fi

  if [ -n "$PARALLAX_IMAGESTORE" ]
  then
    export PARALLAX_IMAGESTORE_ORIG=$PARALLAX_IMAGESTORE
  else
    if [ -n "$SCRATCH" ]
    then
      export PARALLAX_IMAGESTORE="${SCRATCH}/parallax_imagestore"
    else
      export PARALLAX_IMAGESTORE="${TMP_IMAGESTORE}"
    fi
    mkdir -p "${PARALLAX_IMAGESTORE}"
  fi

  export CONTAINERS_CONF="${SARUS_PATH}/etc/containers.conf"
  export PATH="${SARUS_PATH}/bin:${PATH}"
  export PARALLAX_PATH="${SARUS_PATH}/bin/parallax"
  export SARUS_SUITE_GIT_TAG="{{ git_tag }}"
  export SARUS_SUITE_GIT_BRANCH="{{ git_branch }}"
  export SARUS_SUITE_GIT_COMMIT="{{ git_commit }}"
}

function sarus_env_deactivate() {
  SARUS_PATH=$(dirname $(dirname $(readlink -f "${BASH_SOURCE[0]}")))

  if [ -n "$CONTAINERS_CONF" ]
  then
  if [ "$CONTAINERS_CONF" != "${SARUS_PATH}/etc/containers.conf" ]
    then
      echo "Sarus environment is already inactive."
      return 0
    else
      unset CONTAINERS_CONF
    fi
  else
    echo "Sarus environment is already inactive."
    return 0
  fi
 
  unset SARUS_SUITE_GIT_TAG
  unset SARUS_SUITE_GIT_BRANCH
  unset SARUS_SUITE_GIT_COMMIT

  if [ -n "$PATH_ORIG" ]
  then
    export PATH=$PATH_ORIG
    unset PATH_ORIG
  fi

  if [ -n "$CONTAINERS_CONF_ORIG" ]
  then
    export CONTAINERS_CONF=$CONTAINERS_CONF_ORIG
    unset CONTAINERS_CONF_ORIG
  fi

  if [ -n "$PARALLAX_IMAGESTORE_ORIG" ]
  then
    unset PARALLAX_IMAGESTORE_ORIG
  else
    unset PARALLAX_IMAGESTORE
  fi

  unset PARALLAX_PATH
  unset -f get_sarus_env_status
  unset -f sarus_env_activate
  unset -f sarus_env_deactivate
}

[ "$(get_sarus_env_status)" == "inactive" ] && sarus_env_activate
